{% extends "base.html" %}
{% load static %}

{% block title %}{{ client.get_full_name }} - Client Details{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    
    <!-- Breadcrumb -->
    <nav class="flex mb-6" aria-label="Breadcrumb">
        <ol class="inline-flex items-center space-x-1 md:space-x-3">
            <li class="inline-flex items-center">
                <a href="{% url 'clients:client_list' %}" class="text-gray-700 hover:text-primary-600 inline-flex items-center">
                    <i class="fas fa-users mr-2"></i>
                    Clients
                </a>
            </li>
            <li>
                <div class="flex items-center">
                    <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
                    <span class="text-gray-500">{{ client.get_full_name }}</span>
                </div>
            </li>
        </ol>
    </nav>

    <!-- Client Header -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between">
            <div class="flex items-center space-x-4">
                {% if client.profile_photo %}
                <img class="h-20 w-20 rounded-full object-cover" src="{{ client.profile_photo.url }}" alt="{{ client.get_full_name }}">
                {% else %}
                <div class="h-20 w-20 rounded-full bg-gradient-to-br from-primary-400 to-primary-600 flex items-center justify-center">
                    <span class="text-white font-bold text-2xl">{{ client.initials }}</span>
                </div>
                {% endif %}
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">{{ client.get_full_name }}</h1>
                    <p class="text-gray-600 mt-1">
                        <i class="fas fa-id-card mr-1"></i> {{ client.get_id_type_display }}: {{ client.id_number }}
                    </p>
                    <div class="mt-2">
                        {% if client.status == 'active' %}
                        <span class="px-3 py-1 inline-flex text-sm leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                            <i class="fas fa-check-circle mr-1"></i> Active
                        </span>
                        {% elif client.status == 'completed' %}
                        <span class="px-3 py-1 inline-flex text-sm leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                            <i class="fas fa-trophy mr-1"></i> Completed
                        </span>
                        {% elif client.status == 'defaulted' %}
                        <span class="px-3 py-1 inline-flex text-sm leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                            <i class="fas fa-exclamation-triangle mr-1"></i> Defaulted
                        </span>
                        {% else %}
                        <span class="px-3 py-1 inline-flex text-sm leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">
                            <i class="fas fa-minus-circle mr-1"></i> Inactive
                        </span>
                        {% endif %}
                        
                        {% if client.is_blacklisted %}
                        <span class="px-3 py-1 inline-flex text-sm leading-5 font-semibold rounded-full bg-red-100 text-red-800 ml-2">
                            <i class="fas fa-ban mr-1"></i> Blacklisted
                        </span>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="mt-4 md:mt-0 flex flex-wrap gap-2">
                <a href="{% url 'clients:client_update' client.pk %}" 
                   class="inline-flex items-center px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white font-medium rounded-lg transition duration-150 ease-in-out shadow-sm">
                    <i class="fas fa-edit mr-2"></i> Edit
                </a>
                <a href="{% url 'clients:assign_vehicle' client.pk %}" 
                   class="inline-flex items-center px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition duration-150 ease-in-out shadow-sm">
                    <i class="fas fa-car mr-2"></i> Assign Vehicle
                </a>
                <a href="{% url 'clients:upload_document' client.pk %}" 
                   class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition duration-150 ease-in-out shadow-sm">
                    <i class="fas fa-upload mr-2"></i> Upload Document
                </a>
                <a href="{% url 'clients:client_statement' client.pk %}" 
                   class="inline-flex items-center px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg transition duration-150 ease-in-out shadow-sm">
                    <i class="fas fa-file-invoice mr-2"></i> Statement
                </a>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0 bg-blue-100 rounded-lg p-3">
                    <i class="fas fa-car text-2xl text-blue-600"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Total Purchases</p>
                    <p class="text-2xl font-bold text-gray-900">{{ total_purchases }}</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0 bg-green-100 rounded-lg p-3">
                    <i class="fas fa-money-bill-wave text-2xl text-green-600"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Total Spent</p>
                    <p class="text-2xl font-bold text-gray-900">KES {{ total_spent|floatformat:2 }}</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0 bg-purple-100 rounded-lg p-3">
                    <i class="fas fa-check-circle text-2xl text-purple-600"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Amount Paid</p>
                    <p class="text-2xl font-bold text-gray-900">KES {{ total_paid|floatformat:2 }}</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0 bg-red-100 rounded-lg p-3">
                    <i class="fas fa-balance-scale text-2xl text-red-600"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Balance Due</p>
                    <p class="text-2xl font-bold text-gray-900">KES {{ total_balance|floatformat:2 }}</p>
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left Column - Client Information -->
        <div class="lg:col-span-2 space-y-6">
            
            <!-- Personal Information -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-user mr-2"></i> Personal Information
                    </h2>
                </div>
                <div class="p-6">
                    <dl class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Full Name</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ client.get_full_name }}</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Date of Birth</dt>
                            <dd class="mt-1 text-sm text-gray-900">
                                {% if client.date_of_birth %}{{ client.date_of_birth|date:"M d, Y" }}{% else %}N/A{% endif %}
                            </dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Gender</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ client.get_gender_display|default:"N/A" }}</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">ID Type</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ client.get_id_type_display }}</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">ID Number</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ client.id_number }}</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Registered</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ client.date_registered|date:"M d, Y" }}</dd>
                        </div>
                    </dl>
                </div>
            </div>

            <!-- Contact Information -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-address-book mr-2"></i> Contact Information
                    </h2>
                </div>
                <div class="p-6">
                    <dl class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Primary Phone</dt>
                            <dd class="mt-1 text-sm text-gray-900">
                                <i class="fas fa-phone text-primary-500 mr-2"></i>{{ client.phone_primary }}
                            </dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Secondary Phone</dt>
                            <dd class="mt-1 text-sm text-gray-900">
                                {% if client.phone_secondary %}
                                <i class="fas fa-phone text-primary-500 mr-2"></i>{{ client.phone_secondary }}
                                {% else %}N/A{% endif %}
                            </dd>
                        </div>
                        <div class="md:col-span-2">
                            <dt class="text-sm font-medium text-gray-500">Email</dt>
                            <dd class="mt-1 text-sm text-gray-900">
                                {% if client.email %}
                                <i class="fas fa-envelope text-primary-500 mr-2"></i>{{ client.email }}
                                {% else %}N/A{% endif %}
                            </dd>
                        </div>
                        <div class="md:col-span-2">
                            <dt class="text-sm font-medium text-gray-500">Physical Address</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ client.physical_address }}</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">City</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ client.city|default:"N/A" }}</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">County</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ client.county|default:"N/A" }}</dd>
                        </div>
                    </dl>
                </div>
            </div>

            <!-- Employment Information -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-briefcase mr-2"></i> Employment Information
                    </h2>
                </div>
                <div class="p-6">
                    <dl class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Occupation</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ client.occupation|default:"N/A" }}</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Employer</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ client.employer|default:"N/A" }}</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Monthly Income</dt>
                            <dd class="mt-1 text-sm text-gray-900">
                                {% if client.monthly_income %}KES {{ client.monthly_income|floatformat:2 }}{% else %}N/A{% endif %}
                            </dd>
                        </div>
                    </dl>
                </div>
            </div>

            <!-- Next of Kin -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-users mr-2"></i> Next of Kin
                    </h2>
                </div>
                <div class="p-6">
                    <dl class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Name</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ client.next_of_kin_name|default:"N/A" }}</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Phone</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ client.next_of_kin_phone|default:"N/A" }}</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Relationship</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ client.next_of_kin_relationship|default:"N/A" }}</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Address</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ client.next_of_kin_address|default:"N/A" }}</dd>
                        </div>
                    </dl>
                </div>
            </div>

            <!-- Client Vehicles -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                    <h2 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-car mr-2"></i> Vehicles ({{ client_vehicles.count }})
                    </h2>
                    <a href="{% url 'clients:assign_vehicle' client.pk %}" 
                       class="text-sm text-primary-600 hover:text-primary-700 font-medium">
                        <i class="fas fa-plus mr-1"></i> Assign Vehicle
                    </a>
                </div>
                <div class="divide-y divide-gray-200">
                    {% for cv in client_vehicles %}
                    <div class="p-6 hover:bg-gray-50 transition-colors duration-150">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <h3 class="text-lg font-medium text-gray-900">
                                    <a href="{% url 'clients:client_vehicle_detail' cv.pk %}" class="hover:text-primary-600">
                                        {{ cv.vehicle.full_name }}
                                    </a>
                                </h3>
                                <p class="text-sm text-gray-600 mt-1">{{ cv.vehicle.registration_number }}</p>
                                
                                <div class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div>
                                        <p class="text-xs text-gray-500">Purchase Price</p>
                                        <p class="text-sm font-semibold text-gray-900">KES {{ cv.purchase_price|floatformat:2 }}</p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-500">Total Paid</p>
                                        <p class="text-sm font-semibold text-green-600">KES {{ cv.total_paid|floatformat:2 }}</p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-500">Balance</p>
                                        <p class="text-sm font-semibold text-red-600">KES {{ cv.balance|floatformat:2 }}</p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-500">Progress</p>
                                        <p class="text-sm font-semibold text-primary-600">{{ cv.payment_progress|floatformat:1 }}%</p>
                                    </div>
                                </div>

                                <!-- Progress Bar -->
                                <div class="mt-4">
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div class="bg-primary-600 h-2 rounded-full transition-all duration-300" style="width: {{ cv.payment_progress }}%"></div>
                                    </div>
                                </div>

                                <div class="mt-3 flex items-center space-x-4 text-sm text-gray-500">
                                    <span><i class="fas fa-calendar mr-1"></i> Purchased: {{ cv.purchase_date|date:"M d, Y" }}</span>
                                    {% if cv.is_paid_off %}
                                    <span class="text-green-600"><i class="fas fa-check-circle mr-1"></i> Paid Off</span>
                                    {% endif %}
                                </div>
                            </div>
                            <a href="{% url 'clients:client_vehicle_detail' cv.pk %}" 
                               class="ml-4 text-primary-600 hover:text-primary-700">
                                <i class="fas fa-arrow-right"></i>
                            </a>
                        </div>
                    </div>
                    {% empty %}
                    <div class="p-6 text-center text-gray-500">
                        <i class="fas fa-car text-4xl text-gray-300 mb-2"></i>
                        <p>No vehicles assigned yet</p>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Recent Payments -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-receipt mr-2"></i> Recent Payments
                    </h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Vehicle</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Amount</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Method</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for payment in recent_payments %}
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    {{ payment.payment_date|date:"M d, Y" }}
                                </td>
                                <td class="px-6 py-4 text-sm text-gray-900">
                                    {{ payment.client_vehicle.vehicle.registration_number }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-green-600">
                                    KES {{ payment.amount|floatformat:2 }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    {{ payment.get_payment_method_display }}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="px-6 py-4 text-center text-sm text-gray-500">
                                    No payments recorded yet
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Right Column - Credit Info & Documents -->
        <div class="space-y-6">
            
            <!-- Credit Information -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-credit-card mr-2"></i> Credit Information
                    </h2>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <p class="text-sm text-gray-500">Credit Limit</p>
                        <p class="text-2xl font-bold text-gray-900">KES {{ client.credit_limit|floatformat:2 }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Current Debt</p>
                        <p class="text-xl font-semibold text-red-600">KES {{ client.current_debt|floatformat:2 }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Available Credit</p>
                        <p class="text-xl font-semibold text-green-600">KES {{ client.available_credit|floatformat:2 }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 mb-2">Credit Utilization</p>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div class="{% if client.credit_utilization > 75 %}bg-red-600{% elif client.credit_utilization > 50 %}bg-yellow-600{% else %}bg-green-600{% endif %} h-3 rounded-full" style="width: {{ client.credit_utilization }}%"></div>
                        </div>
                        <p class="text-sm font-medium text-gray-700 mt-1">{{ client.credit_utilization|floatformat:1 }}%</p>
                    </div>
                </div>
            </div>

            <!-- Documents -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                    <h2 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-folder mr-2"></i> Documents ({{ documents.count }})
                    </h2>
                    <a href="{% url 'clients:upload_document' client.pk %}" 
                       class="text-sm text-primary-600 hover:text-primary-700 font-medium">
                        <i class="fas fa-plus mr-1"></i> Upload
                    </a>
                </div>
                <div class="divide-y divide-gray-200 max-h-96 overflow-y-auto">
                    {% for doc in documents %}
                    <div class="p-4 hover:bg-gray-50 transition-colors duration-150">
                        <div class="flex items-start space-x-3">
                            <div class="flex-shrink-0">
                                <i class="fas fa-file-pdf text-2xl text-red-500"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-gray-900 truncate">{{ doc.title }}</p>
                                <p class="text-xs text-gray-500 mt-1">{{ doc.get_document_type_display }}</p>
                                <p class="text-xs text-gray-400 mt-1">
                                    <i class="fas fa-clock mr-1"></i>{{ doc.uploaded_at|date:"M d, Y" }}
                                </p>
                            </div>
                            <a href="{{ doc.file.url }}" target="_blank" 
                               class="flex-shrink-0 text-primary-600 hover:text-primary-700">
                                <i class="fas fa-download"></i>
                            </a>
                        </div>
                    </div>
                    {% empty %}
                    <div class="p-6 text-center text-gray-500">
                        <i class="fas fa-folder-open text-4xl text-gray-300 mb-2"></i>
                        <p class="text-sm">No documents uploaded</p>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Notes -->
            {% if client.notes %}
            <div class="bg-yellow-50 rounded-lg border border-yellow-200 p-6">
                <h3 class="text-sm font-semibold text-yellow-900 mb-2">
                    <i class="fas fa-sticky-note mr-2"></i> Notes
                </h3>
                <p class="text-sm text-yellow-800">{{ client.notes }}</p>
            </div>
            {% endif %}

            {% if client.is_blacklisted %}
            <div class="bg-red-50 rounded-lg border border-red-200 p-6">
                <h3 class="text-sm font-semibold text-red-900 mb-2">
                    <i class="fas fa-ban mr-2"></i> Blacklist Reason
                </h3>
                <p class="text-sm text-red-800">{{ client.blacklist_reason }}</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
