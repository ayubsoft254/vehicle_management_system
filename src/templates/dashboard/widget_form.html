{% extends 'base.html' %}
{% load static %}

{% block title %}{% if widget %}Edit Widget{% else %}Add Widget{% endif %}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Breadcrumb -->
    <nav class="text-sm mb-6">
        <ol class="list-none p-0 inline-flex">
            <li class="flex items-center">
                <a href="{% url 'dashboard:home' %}" class="text-primary-600 hover:text-primary-700">Dashboard</a>
                <i class="fas fa-chevron-right mx-2 text-gray-400 text-xs"></i>
            </li>
            <li class="flex items-center">
                <a href="{% url 'dashboard:dashboard_detail' dashboard.pk %}" class="text-primary-600 hover:text-primary-700">{{ dashboard.name }}</a>
                <i class="fas fa-chevron-right mx-2 text-gray-400 text-xs"></i>
            </li>
            <li class="text-gray-500">{% if widget %}Edit Widget{% else %}Add Widget{% endif %}</li>
        </ol>
    </nav>

    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800">
            <i class="fas {% if widget %}fa-edit{% else %}fa-plus{% endif %} text-purple-600 mr-2"></i>
            {% if widget %}Edit Widget{% else %}Add Widget{% endif %}
        </h1>
        <p class="text-gray-600 mt-1">{% if widget %}Update widget settings{% else %}Add a new widget to {{ dashboard.name }}{% endif %}</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Form -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-xl shadow-md p-6">
                <form method="post" class="space-y-6">
                    {% csrf_token %}

                    <!-- Error Messages -->
                    {% if form.non_field_errors %}
                        <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded">
                            <div class="flex">
                                <i class="fas fa-exclamation-circle text-red-500 mr-3 mt-1"></i>
                                <div>
                                    <h3 class="text-red-800 font-medium">Please correct the errors below:</h3>
                                    <ul class="list-disc list-inside text-red-700 text-sm mt-2">
                                        {% for error in form.non_field_errors %}
                                            <li>{{ error }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    {% endif %}

                    <!-- Basic Information -->
                    <div class="border-b border-gray-200 pb-6">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">
                            <i class="fas fa-info-circle text-blue-600 mr-2"></i>Basic Information
                        </h3>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Widget Name -->
                            <div class="md:col-span-2">
                                <label for="{{ form.name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Widget Name <span class="text-red-500">*</span>
                                </label>
                                {{ form.name }}
                                {% if form.name.errors %}
                                    <p class="text-xs text-red-500 mt-1">{{ form.name.errors.0 }}</p>
                                {% endif %}
                            </div>

                            <!-- Widget Type -->
                            <div>
                                <label for="{{ form.widget_type.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Widget Type <span class="text-red-500">*</span>
                                </label>
                                {{ form.widget_type }}
                                {% if form.widget_type.errors %}
                                    <p class="text-xs text-red-500 mt-1">{{ form.widget_type.errors.0 }}</p>
                                {% endif %}
                            </div>

                            <!-- Chart Type -->
                            <div>
                                <label for="{{ form.chart_type.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Chart Type
                                </label>
                                {{ form.chart_type }}
                                {% if form.chart_type.errors %}
                                    <p class="text-xs text-red-500 mt-1">{{ form.chart_type.errors.0 }}</p>
                                {% endif %}
                            </div>

                            <!-- Description -->
                            <div class="md:col-span-2">
                                <label for="{{ form.description.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Description
                                </label>
                                {{ form.description }}
                                {% if form.description.errors %}
                                    <p class="text-xs text-red-500 mt-1">{{ form.description.errors.0 }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Data Configuration -->
                    <div class="border-b border-gray-200 pb-6">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">
                            <i class="fas fa-database text-green-600 mr-2"></i>Data Configuration
                        </h3>

                        <!-- Data Source -->
                        <div class="mb-4">
                            <label for="{{ form.data_source.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                Data Source <span class="text-red-500">*</span>
                            </label>
                            {{ form.data_source }}
                            <p class="text-xs text-gray-500 mt-1">
                                <i class="fas fa-info-circle mr-1"></i>
                                Model name or API endpoint (e.g., Vehicle, Payment, Client)
                            </p>
                            {% if form.data_source.errors %}
                                <p class="text-xs text-red-500 mt-1">{{ form.data_source.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <!-- Query Config -->
                        <div>
                            <label for="{{ form.query_config.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                Query Configuration (JSON)
                            </label>
                            {{ form.query_config }}
                            <p class="text-xs text-gray-500 mt-1">
                                <i class="fas fa-info-circle mr-1"></i>
                                JSON object with filters, aggregations, and query parameters
                            </p>
                            {% if form.query_config.errors %}
                                <p class="text-xs text-red-500 mt-1">{{ form.query_config.errors.0 }}</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Layout & Sizing -->
                    <div class="border-b border-gray-200 pb-6">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">
                            <i class="fas fa-expand text-purple-600 mr-2"></i>Layout & Sizing
                        </h3>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <!-- Size -->
                            <div>
                                <label for="{{ form.size.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Size <span class="text-red-500">*</span>
                                </label>
                                {{ form.size }}
                                {% if form.size.errors %}
                                    <p class="text-xs text-red-500 mt-1">{{ form.size.errors.0 }}</p>
                                {% endif %}
                            </div>

                            <!-- Width -->
                            <div>
                                <label for="{{ form.width.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Width (columns)
                                </label>
                                {{ form.width }}
                                <p class="text-xs text-gray-500 mt-1">1-12 columns</p>
                                {% if form.width.errors %}
                                    <p class="text-xs text-red-500 mt-1">{{ form.width.errors.0 }}</p>
                                {% endif %}
                            </div>

                            <!-- Height -->
                            <div>
                                <label for="{{ form.height.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Height (px)
                                </label>
                                {{ form.height }}
                                <p class="text-xs text-gray-500 mt-1">Minimum 100px</p>
                                {% if form.height.errors %}
                                    <p class="text-xs text-red-500 mt-1">{{ form.height.errors.0 }}</p>
                                {% endif %}
                            </div>

                            <!-- Order -->
                            <div>
                                <label for="{{ form.order.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Display Order
                                </label>
                                {{ form.order }}
                                <p class="text-xs text-gray-500 mt-1">Lower number = first</p>
                                {% if form.order.errors %}
                                    <p class="text-xs text-red-500 mt-1">{{ form.order.errors.0 }}</p>
                                {% endif %}
                            </div>

                            <!-- Position X -->
                            <div>
                                <label for="{{ form.position_x.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Position X
                                </label>
                                {{ form.position_x }}
                                {% if form.position_x.errors %}
                                    <p class="text-xs text-red-500 mt-1">{{ form.position_x.errors.0 }}</p>
                                {% endif %}
                            </div>

                            <!-- Position Y -->
                            <div>
                                <label for="{{ form.position_y.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Position Y
                                </label>
                                {{ form.position_y }}
                                {% if form.position_y.errors %}
                                    <p class="text-xs text-red-500 mt-1">{{ form.position_y.errors.0 }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Appearance -->
                    <div class="border-b border-gray-200 pb-6">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">
                            <i class="fas fa-paint-brush text-pink-600 mr-2"></i>Appearance
                        </h3>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <!-- Title Color -->
                            <div>
                                <label for="{{ form.title_color.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Title Color
                                </label>
                                <div class="flex gap-2">
                                    {{ form.title_color }}
                                    <input type="text" id="title_color_text" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg" placeholder="#000000" readonly>
                                </div>
                            </div>

                            <!-- Background Color -->
                            <div>
                                <label for="{{ form.background_color.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Background Color
                                </label>
                                <div class="flex gap-2">
                                    {{ form.background_color }}
                                    <input type="text" id="background_color_text" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg" placeholder="#FFFFFF" readonly>
                                </div>
                            </div>
                        </div>

                        <!-- Display Options -->
                        <div class="space-y-3">
                            <div class="flex items-center">
                                <div class="flex items-center h-5">
                                    {{ form.show_title }}
                                </div>
                                <label for="{{ form.show_title.id_for_label }}" class="ml-3 text-sm font-medium text-gray-700">
                                    Show Widget Title
                                </label>
                            </div>

                            <div class="flex items-center">
                                <div class="flex items-center h-5">
                                    {{ form.show_border }}
                                </div>
                                <label for="{{ form.show_border.id_for_label }}" class="ml-3 text-sm font-medium text-gray-700">
                                    Show Widget Border
                                </label>
                            </div>
                        </div>

                        <!-- Custom CSS -->
                        <div class="mt-4">
                            <label for="{{ form.custom_css.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                Custom CSS
                            </label>
                            {{ form.custom_css }}
                            <p class="text-xs text-gray-500 mt-1">Advanced: Add custom styling for this widget</p>
                        </div>
                    </div>

                    <!-- Refresh Settings -->
                    <div class="border-b border-gray-200 pb-6">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">
                            <i class="fas fa-sync text-blue-600 mr-2"></i>Refresh Settings
                        </h3>

                        <div class="space-y-4">
                            <div class="flex items-start">
                                <div class="flex items-center h-5">
                                    {{ form.auto_refresh }}
                                </div>
                                <div class="ml-3">
                                    <label for="{{ form.auto_refresh.id_for_label }}" class="font-medium text-gray-700">
                                        Enable Auto-Refresh
                                    </label>
                                    <p class="text-xs text-gray-500">Automatically update widget data</p>
                                </div>
                            </div>

                            <div id="refreshIntervalContainer" class="ml-8 {% if not form.auto_refresh.value %}hidden{% endif %}">
                                <label for="{{ form.refresh_interval.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Refresh Interval (seconds)
                                </label>
                                {{ form.refresh_interval }}
                                <p class="text-xs text-gray-500 mt-1">Minimum 60 seconds</p>
                            </div>

                            <div class="flex items-center">
                                <div class="flex items-center h-5">
                                    {{ form.is_active }}
                                </div>
                                <label for="{{ form.is_active.id_for_label }}" class="ml-3 text-sm font-medium text-gray-700">
                                    Active
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Config -->
                    <div>
                        <h3 class="text-lg font-bold text-gray-900 mb-4">
                            <i class="fas fa-cog text-gray-600 mr-2"></i>Advanced Configuration
                        </h3>

                        <div>
                            <label for="{{ form.custom_config.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                Custom Configuration (JSON)
                            </label>
                            {{ form.custom_config }}
                            <p class="text-xs text-gray-500 mt-1">
                                <i class="fas fa-info-circle mr-1"></i>
                                Additional widget-specific configuration options
                            </p>
                        </div>
                    </div>

                    <!-- Hidden Dashboard Field -->
                    <input type="hidden" name="{{ form.dashboard.html_name }}" value="{{ dashboard.pk }}">

                    <!-- Buttons -->
                    <div class="flex items-center gap-4 pt-6 border-t">
                        <button type="submit" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-semibold transition duration-200">
                            <i class="fas fa-save mr-2"></i>{% if widget %}Update Widget{% else %}Add Widget{% endif %}
                        </button>
                        <a href="{% url 'dashboard:dashboard_detail' dashboard.pk %}" class="flex-1 text-center bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-3 rounded-lg font-semibold transition duration-200">
                            <i class="fas fa-times mr-2"></i>Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="lg:col-span-1 space-y-6">
            <!-- Widget Types -->
            <div class="bg-blue-50 rounded-xl border border-blue-200 p-6">
                <h3 class="text-lg font-bold text-blue-900 mb-4">
                    <i class="fas fa-th-large mr-2"></i>Widget Types
                </h3>
                <div class="space-y-2 text-sm text-blue-800">
                    <div><i class="fas fa-tachometer-alt mr-2"></i>Metric - Single value display</div>
                    <div><i class="fas fa-chart-bar mr-2"></i>Chart - Visual data representation</div>
                    <div><i class="fas fa-list mr-2"></i>List - Tabular data display</div>
                    <div><i class="fas fa-map mr-2"></i>Map - Geographic visualization</div>
                    <div><i class="fas fa-table mr-2"></i>Table - Detailed data table</div>
                    <div><i class="fas fa-code mr-2"></i>Custom - HTML/JavaScript widget</div>
                </div>
            </div>

            <!-- Chart Types -->
            <div class="bg-green-50 rounded-xl border border-green-200 p-6">
                <h3 class="text-lg font-bold text-green-900 mb-4">
                    <i class="fas fa-chart-line mr-2"></i>Chart Types
                </h3>
                <div class="space-y-2 text-sm text-green-800">
                    <div><i class="fas fa-chart-line mr-2"></i>Line - Trends over time</div>
                    <div><i class="fas fa-chart-bar mr-2"></i>Bar - Comparisons</div>
                    <div><i class="fas fa-chart-pie mr-2"></i>Pie - Proportions</div>
                    <div><i class="fas fa-chart-area mr-2"></i>Area - Cumulative data</div>
                    <div><i class="fas fa-circle-notch mr-2"></i>Donut - Percentages</div>
                </div>
            </div>

            <!-- Size Guide -->
            <div class="bg-purple-50 rounded-xl border border-purple-200 p-6">
                <h3 class="text-lg font-bold text-purple-900 mb-4">
                    <i class="fas fa-expand-arrows-alt mr-2"></i>Widget Sizes
                </h3>
                <div class="space-y-2 text-sm text-purple-800">
                    <div><strong>Small:</strong> 1 column width</div>
                    <div><strong>Medium:</strong> 2 columns width</div>
                    <div><strong>Large:</strong> 3 columns width</div>
                    <div><strong>Full:</strong> Full dashboard width</div>
                </div>
            </div>

            <!-- Tips -->
            <div class="bg-yellow-50 rounded-xl border border-yellow-200 p-6">
                <h3 class="text-lg font-bold text-yellow-900 mb-4">
                    <i class="fas fa-lightbulb mr-2"></i>Tips
                </h3>
                <ul class="space-y-2 text-sm text-yellow-800">
                    <li class="flex items-start">
                        <i class="fas fa-check text-yellow-600 mr-2 mt-1"></i>
                        <span>Use descriptive names for widgets</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check text-yellow-600 mr-2 mt-1"></i>
                        <span>Test query config before saving</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check text-yellow-600 mr-2 mt-1"></i>
                        <span>Keep refresh intervals reasonable</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check text-yellow-600 mr-2 mt-1"></i>
                        <span>Use custom CSS sparingly</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
// Toggle refresh interval field
document.addEventListener('DOMContentLoaded', function() {
    const autoRefreshCheckbox = document.getElementById('{{ form.auto_refresh.id_for_label }}');
    const refreshIntervalContainer = document.getElementById('refreshIntervalContainer');

    if (autoRefreshCheckbox) {
        autoRefreshCheckbox.addEventListener('change', function() {
            refreshIntervalContainer.classList.toggle('hidden', !this.checked);
        });
    }

    // Color picker sync
    const titleColorInput = document.getElementById('{{ form.title_color.id_for_label }}');
    const titleColorText = document.getElementById('title_color_text');
    
    if (titleColorInput && titleColorText) {
        titleColorInput.addEventListener('input', function() {
            titleColorText.value = this.value;
        });
        titleColorText.value = titleColorInput.value || '#000000';
    }

    const bgColorInput = document.getElementById('{{ form.background_color.id_for_label }}');
    const bgColorText = document.getElementById('background_color_text');
    
    if (bgColorInput && bgColorText) {
        bgColorInput.addEventListener('input', function() {
            bgColorText.value = this.value;
        });
        bgColorText.value = bgColorInput.value || '#FFFFFF';
    }
});
</script>
{% endblock %}
