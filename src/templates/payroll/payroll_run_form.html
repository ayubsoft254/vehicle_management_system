{% extends "base.html" %}
{% load static %}

{% block title %}Create Payroll Run{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6 max-w-2xl">
    
    <!-- Back Button -->
    <div class="mb-4">
        <a href="{% url 'payroll:payroll_run_list' %}" 
           class="inline-flex items-center text-sm text-gray-600 hover:text-gray-900">
            <i class="fas fa-arrow-left mr-2"></i> Back to Payroll Runs
        </a>
    </div>

    <!-- Page Header -->
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-900">
            {% if form.instance.pk %}Edit{% else %}Create{% endif %} Payroll Run
        </h1>
        <p class="mt-1 text-sm text-gray-600">Set up a new payroll processing period</p>
    </div>

    <!-- Info Box -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
        <div class="flex items-start">
            <i class="fas fa-info-circle text-blue-600 text-xl mr-3 mt-1"></i>
            <div>
                <h3 class="text-sm font-bold text-blue-900 mb-2">Before You Begin</h3>
                <ul class="text-sm text-blue-800 space-y-1">
                    <li>• Ensure all employee salary structures are up to date</li>
                    <li>• Verify that attendance records for the period are complete</li>
                    <li>• Review and approve all pending commissions and deductions</li>
                    <li>• Check that all leave applications have been processed</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Form -->
    <form method="post" class="bg-white rounded-lg shadow-sm border border-gray-200">
        {% csrf_token %}
        
        <!-- Basic Information -->
        <div class="p-6 border-b border-gray-200">
            <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-calendar text-primary-600 mr-2"></i>
                Payroll Period
            </h2>
            <div class="space-y-4">
                <div>
                    <label for="id_month" class="block text-sm font-medium text-gray-700 mb-1">Payroll Month *</label>
                    <input type="month" 
                           name="month" 
                           id="id_month"
                           value="{{ form.month.value|default:'' }}"
                           required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                    <p class="mt-1 text-xs text-gray-500">Select the month for this payroll run</p>
                    {% if form.month.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.month.errors.0 }}</p>
                    {% endif %}
                </div>
                <div>
                    <label for="id_name" class="block text-sm font-medium text-gray-700 mb-1">Payroll Run Name *</label>
                    <input type="text" 
                           name="name" 
                           id="id_name"
                           value="{{ form.name.value|default:'' }}"
                           required
                           maxlength="200"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                           placeholder="e.g., January 2025 Payroll">
                    <p class="mt-1 text-xs text-gray-500">e.g., "January 2025 Payroll" or "Mid-Month Bonus"</p>
                    {% if form.name.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.name.errors.0 }}</p>
                    {% endif %}
                </div>
                <div>
                    <label for="id_description" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea name="description" 
                              id="id_description"
                              rows="3"
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                              placeholder="Additional notes or details about this payroll run">{{ form.description.value|default:'' }}</textarea>
                    <p class="mt-1 text-xs text-gray-500">Additional notes or details about this payroll run</p>
                    {% if form.description.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.description.errors.0 }}</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Working Days -->
        <div class="p-6 border-b border-gray-200">
            <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-business-time text-primary-600 mr-2"></i>
                Working Period
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="id_period_start" class="block text-sm font-medium text-gray-700 mb-1">Period Start Date *</label>
                    <input type="date" 
                           name="period_start" 
                           id="id_period_start"
                           value="{{ form.period_start.value|date:'Y-m-d'|default:'' }}"
                           required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                    {% if form.period_start.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.period_start.errors.0 }}</p>
                    {% endif %}
                </div>
                <div>
                    <label for="id_period_end" class="block text-sm font-medium text-gray-700 mb-1">Period End Date *</label>
                    <input type="date" 
                           name="period_end" 
                           id="id_period_end"
                           value="{{ form.period_end.value|date:'Y-m-d'|default:'' }}"
                           required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                    {% if form.period_end.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.period_end.errors.0 }}</p>
                    {% endif %}
                </div>
            </div>
            <div class="mt-4">
                <label for="id_working_days" class="block text-sm font-medium text-gray-700 mb-1">Working Days</label>
                <input type="number" 
                       name="working_days" 
                       id="id_working_days"
                       value="{{ form.working_days.value|default:'' }}"
                       min="1"
                       max="31"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                       placeholder="22">
                <p class="mt-1 text-xs text-gray-500">Number of working days in this period (excluding weekends/holidays)</p>
                {% if form.working_days.errors %}
                <p class="mt-1 text-sm text-red-600">{{ form.working_days.errors.0 }}</p>
                {% endif %}
            </div>
        </div>

        <!-- Payment Schedule -->
        <div class="p-6 border-b border-gray-200">
            <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-money-check text-primary-600 mr-2"></i>
                Payment Schedule
            </h2>
            <div>
                <label for="id_payment_date" class="block text-sm font-medium text-gray-700 mb-1">Payment Date *</label>
                <input type="date" 
                       name="payment_date" 
                       id="id_payment_date"
                       value="{{ form.payment_date.value|date:'Y-m-d'|default:'' }}"
                       required
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                <p class="mt-1 text-xs text-gray-500">Scheduled date for salary disbursement</p>
                {% if form.payment_date.errors %}
                <p class="mt-1 text-sm text-red-600">{{ form.payment_date.errors.0 }}</p>
                {% endif %}
            </div>
        </div>

        <!-- Additional Options -->
        <div class="p-6 border-b border-gray-200">
            <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-cog text-primary-600 mr-2"></i>
                Additional Options
            </h2>
            <div class="space-y-3">
                <label class="flex items-start cursor-pointer">
                    <input type="checkbox" 
                           name="include_commissions" 
                           id="id_include_commissions"
                           {% if form.include_commissions.value %}checked{% endif %}
                           class="mt-1 w-5 h-5 text-primary-600 border-gray-300 rounded focus:ring-2 focus:ring-primary-500">
                    <span class="ml-3 text-sm text-gray-700">
                        <span class="font-medium">Include Commissions</span>
                        <span class="block text-xs text-gray-500">Process all approved commissions for this period</span>
                    </span>
                </label>
                <label class="flex items-start cursor-pointer">
                    <input type="checkbox" 
                           name="include_bonuses" 
                           id="id_include_bonuses"
                           {% if form.include_bonuses.value %}checked{% endif %}
                           class="mt-1 w-5 h-5 text-primary-600 border-gray-300 rounded focus:ring-2 focus:ring-primary-500">
                    <span class="ml-3 text-sm text-gray-700">
                        <span class="font-medium">Include Bonuses</span>
                        <span class="block text-xs text-gray-500">Add performance bonuses to this payroll</span>
                    </span>
                </label>
                <label class="flex items-start cursor-pointer">
                    <input type="checkbox" 
                           name="include_overtime" 
                           id="id_include_overtime"
                           {% if form.include_overtime.value %}checked{% endif %}
                           class="mt-1 w-5 h-5 text-primary-600 border-gray-300 rounded focus:ring-2 focus:ring-primary-500">
                    <span class="ml-3 text-sm text-gray-700">
                        <span class="font-medium">Include Overtime</span>
                        <span class="block text-xs text-gray-500">Calculate and include overtime payments</span>
                    </span>
                </label>
                <label class="flex items-start cursor-pointer">
                    <input type="checkbox" 
                           name="auto_calculate_deductions" 
                           id="id_auto_calculate_deductions"
                           {% if form.auto_calculate_deductions.value %}checked{% endif %}
                           class="mt-1 w-5 h-5 text-primary-600 border-gray-300 rounded focus:ring-2 focus:ring-primary-500">
                    <span class="ml-3 text-sm text-gray-700">
                        <span class="font-medium">Auto-Calculate Deductions</span>
                        <span class="block text-xs text-gray-500">Automatically apply statutory and recurring deductions</span>
                    </span>
                </label>
            </div>
        </div>

        <!-- Quick Summary (if editing) -->
        {% if form.instance.pk %}
        <div class="p-6 border-b border-gray-200 bg-gray-50">
            <h2 class="text-lg font-bold text-gray-900 mb-3">Current Summary</h2>
            <div class="grid grid-cols-2 gap-4 text-sm">
                <div>
                    <p class="text-gray-600">Total Employees:</p>
                    <p class="font-bold text-gray-900">{{ form.instance.total_employees|default:"0" }}</p>
                </div>
                <div>
                    <p class="text-gray-600">Status:</p>
                    <p class="font-bold text-gray-900">{{ form.instance.get_status_display }}</p>
                </div>
                <div>
                    <p class="text-gray-600">Total Gross:</p>
                    <p class="font-bold text-green-600">KES {{ form.instance.total_gross|floatformat:0|default:"0" }}</p>
                </div>
                <div>
                    <p class="text-gray-600">Total Net:</p>
                    <p class="font-bold text-primary-600">KES {{ form.instance.total_net|floatformat:0|default:"0" }}</p>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Form Actions -->
        <div class="p-6 bg-gray-50 flex justify-end space-x-3">
            <a href="{% url 'payroll:payroll_run_list' %}" 
               class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-50 transition duration-150 ease-in-out">
                Cancel
            </a>
            <button type="submit" name="action" value="save_draft"
                    class="px-6 py-2 border border-primary-600 text-primary-600 font-medium rounded-lg hover:bg-primary-50 transition duration-150 ease-in-out">
                <i class="fas fa-save mr-2"></i> Save as Draft
            </button>
            <button type="submit" name="action" value="save_and_process"
                    class="px-6 py-2 bg-primary-600 hover:bg-primary-700 text-white font-medium rounded-lg transition duration-150 ease-in-out">
                <i class="fas fa-play-circle mr-2"></i> Save & Process
            </button>
        </div>
    </form>
</div>



<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-populate name from month selection
    const monthInput = document.getElementById('id_month');
    const nameInput = document.getElementById('id_name');
    
    if (monthInput && nameInput) {
        monthInput.addEventListener('change', function() {
            if (this.value && !nameInput.value) {
                const date = new Date(this.value + '-01');
                const monthName = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                nameInput.value = monthName + ' Payroll';
            }
        });
    }

    // Calculate working days based on period
    const startDate = document.getElementById('id_period_start');
    const endDate = document.getElementById('id_period_end');
    const workingDaysInput = document.getElementById('id_working_days');

    function calculateWorkingDays() {
        if (startDate.value && endDate.value) {
            const start = new Date(startDate.value);
            const end = new Date(endDate.value);
            
            if (start > end) {
                alert('Start date must be before end date');
                return;
            }
            
            let workingDays = 0;
            let currentDate = new Date(start);
            
            while (currentDate <= end) {
                const dayOfWeek = currentDate.getDay();
                if (dayOfWeek !== 0 && dayOfWeek !== 6) { // Exclude Sunday (0) and Saturday (6)
                    workingDays++;
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            if (!workingDaysInput.value || workingDaysInput.value === '0') {
                workingDaysInput.value = workingDays;
            } else if (confirm('Auto-calculate working days? Current value: ' + workingDaysInput.value)) {
                workingDaysInput.value = workingDays;
            }
        }
    }

    if (startDate && endDate && workingDaysInput) {
        startDate.addEventListener('change', calculateWorkingDays);
        endDate.addEventListener('change', calculateWorkingDays);
    }

    // Set default month to current month if creating new
    if (monthInput && !monthInput.value) {
        const today = new Date();
        const currentMonth = today.toISOString().slice(0, 7); // Format: YYYY-MM
        monthInput.value = currentMonth;
        
        // Trigger change event to auto-populate name
        const event = new Event('change');
        monthInput.dispatchEvent(event);
    }
});
</script>
{% endblock %}
